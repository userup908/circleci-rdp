version: 2.1
orbs:
  win: circleci/windows@5.0

jobs:
  build:
    executor:
      name: win/default
      size: medium
    
    steps:
      - run:
          name: Setup and Install Avica
          shell: powershell.exe
          no_output_timeout: 30m
          command: |
            Write-Host "🚀 Starting enhanced Avica setup..." -ForegroundColor Green
            
            # Environment info
            Write-Host "🔍 Environment Info:" -ForegroundColor Cyan
            Write-Host "User: $env:USERNAME"
            Write-Host "Computer: $env:COMPUTERNAME"
            Write-Host "Working Directory: $(Get-Location)"
            python --version
            
            # Download files
            Write-Host "`n📥 Downloading files..." -ForegroundColor Yellow
            
            # Download the fixed setup.py (you'll need to upload this to your repo)
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/free-rd-h4k3r/-/raw/main/setup.py" -OutFile "setup.py"
                Write-Host "✅ setup.py downloaded"
            } catch {
                Write-Host "❌ Download failed, creating local version..."
                # The complete setup.py content would go here
            }
            
            try {
                Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
                Write-Host "✅ Avica installer downloaded"
            } catch {
                Write-Host "❌ Failed to download Avica installer"
                exit 1
            }
            
            # Install Python packages
            Write-Host "`n📦 Installing packages..." -ForegroundColor Yellow
            python -m pip install --upgrade pip --quiet
            python -m pip install requests Pillow pyautogui --quiet
            Write-Host "✅ Packages installed"
            
            # Enable RDP
            Write-Host "`n🔧 Enabling RDP..." -ForegroundColor Yellow
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
            net user $env:USERNAME TheDisa1a
            Write-Host "✅ RDP configured"
            
            # Run the enhanced setup
            Write-Host "`n🐍 Running enhanced setup..." -ForegroundColor Yellow
            python setup.py
            
            Write-Host "`n🎉 Setup completed!" -ForegroundColor Green

      - run:
          name: Keep Session Active
          shell: cmd.exe
          no_output_timeout: 6h
          command: |
            echo 🔧 Starting session keeper...
            :loop
            timeout /t 300 /nobreak >nul 2>&1
            echo Still running... %time%
            goto loop

workflows:
  version: 2
  rdp-workflow:
    jobs:
      - build
