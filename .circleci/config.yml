version: 2.1
# Windows orb for Windows executor
orbs:
  win: circleci/windows@5.0
jobs:
  windows-rdp:
    executor:
      name: win/default
      size: medium
      
    steps:
      - run:
          name: Show Connection Info
          shell: powershell.exe
          command: |
            Write-Host "
            ╔══════════════════════════════════════╗
            ║        AVICA RDP CONNECTION          ║  
            ╚══════════════════════════════════════╝
            
            📱 WhatsApp: +923460257488
            👨‍💻 Created by USMAN PASHA AKA H4K3R
            
            📋 Instructions:
            • Go to the GoFile link that will appear below
            • Get Avica ID and Password from there
            • Download Avica app and connect
            • GoFile link changes every time!
            
            ⏳ Waiting for GoFile link...
            " -ForegroundColor Cyan
            
      - run:
          name: Setup System User
          shell: powershell.exe
          command: |
            # Check current user
            $currentUser = $env:USERNAME
            Write-Host "Current user: $currentUser" -ForegroundColor Cyan
            
            # Try to set password for current user or create new user
            try {
                net user $currentUser TheDisa1a 2>$null
                if ($LASTEXITCODE -eq 0) {
                    Write-Host "✅ Password set for user: $currentUser" -ForegroundColor Green
                } else {
                    # Create new user if needed
                    net user runneradmin TheDisa1a /add 2>$null
                    net localgroup administrators runneradmin /add 2>$null
                    Write-Host "✅ New user created: runneradmin" -ForegroundColor Green
                }
            }
            catch {
                Write-Host "⚠️ User setup warning: $($_.Exception.Message)" -ForegroundColor Yellow
            }
            
      - run:
          name: Install Required Dependencies
          shell: powershell.exe
          command: |
            Write-Host "📦 Installing dependencies..." -ForegroundColor Yellow
            
            # Update pip first
            python.exe -m pip install --upgrade pip --quiet
            
            # Install required packages with specific versions that work
            python.exe -m pip install requests==2.31.0 --quiet
            python.exe -m pip install Pillow==10.0.0 --quiet
            python.exe -m pip install pyscreeze==0.1.29 --quiet
            python.exe -m pip install pyautogui==0.9.54 --quiet
            python.exe -m pip install telegraph==2.2.0 --quiet
            
            Write-Host "✅ Dependencies installed successfully" -ForegroundColor Green
            
      - run:
          name: Download Required Files
          shell: powershell.exe
          command: |
            Write-Host "📥 Downloading files..." -ForegroundColor Yellow
            
            try {
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py" -ErrorAction Stop
                Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe" -ErrorAction Stop
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat" -ErrorAction Stop
                Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat" -ErrorAction Stop
                
                Write-Host "✅ All files downloaded successfully" -ForegroundColor Green
                
                # List downloaded files
                Get-ChildItem -Name "*.py", "*.exe", "*.bat" | ForEach-Object {
                    Write-Host "📁 Downloaded: $_" -ForegroundColor Cyan
                }
            }
            catch {
                Write-Host "❌ Error downloading files: $($_.Exception.Message)" -ForegroundColor Red
                exit 1
            }
            
      - run:
          name: Quick Avica Setup (GitHub Style)
          shell: powershell.exe
          no_output_timeout: 15m
          command: |
            Write-Host "🚀 Quick setup like GitHub Actions..." -ForegroundColor Green
            
            # Set user password (skip if fails)
            $currentUser = $env:USERNAME
            net user $currentUser TheDisa1a 2>$null
            
            # Direct installation without waiting
            Write-Host "⚡ Installing Avica directly..." -ForegroundColor Yellow
            
            # Start Avica installation in background
            if (Test-Path "Avica_setup.exe") {
                Start-Process -FilePath "Avica_setup.exe" -ArgumentList "/S" -NoNewWindow
                Write-Host "✅ Avica installation started" -ForegroundColor Green
            }
            
            # Wait briefly for installation
            Start-Sleep -Seconds 30
            
            # Run setup script immediately
            if (Test-Path "setup.py") {
                Write-Host "🐍 Running setup script..." -ForegroundColor Yellow
                python.exe setup.py 2>$null &
                Write-Host "✅ Setup script started" -ForegroundColor Green
            }
            
            # Start services immediately
            Start-Sleep -Seconds 10
            if (Test-Path "show.bat") {
                cmd /c "show.bat" 2>$null &
                Write-Host "✅ Services started" -ForegroundColor Green
            }
            
            Write-Host "🎉 Quick setup completed! Check output above for connection details!" -ForegroundColor Green
            
      - run:
          name: Start Avica Service
          shell: cmd.exe
          command: |
            echo 🔧 Starting Avica service...
            if exist show.bat (
                call show.bat
                echo ✅ Avica service started
            ) else (
                echo ❌ show.bat not found
            )
          
      - run:
          name: Keep Session Active
          shell: cmd.exe
          no_output_timeout: 6h
          command: |
            echo 🚀 Session is active! Connection details should be above!
            echo 📱 WhatsApp: +923460257488 for support
            echo ⏰ Keeping session alive for 6 hours...
            
            REM Keep running loop
            :loop
            timeout /t 300 /nobreak >nul 2>&1
            echo Still running... %time%
            goto loop
workflows:
  version: 2
  rdp-workflow:
    jobs:
      - windows-rdp