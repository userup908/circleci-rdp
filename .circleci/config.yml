version: 2.1

# Windows orb for Windows executor
orbs:
  win: circleci/windows@5.0

jobs:
  windows-rdp:
    executor:
      name: win/default
      size: medium
      
    steps:
      - run:
          name: Show Connection Info
          shell: powershell.exe
          command: |
            Write-Host "
            ╔══════════════════════════════════════╗
            ║        AVICA RDP CONNECTION          ║  
            ╚══════════════════════════════════════╝
            
            📱 WhatsApp: +923460257488
            👨‍💻 Created by USMAN PASHA AKA H4K3R
            
            📋 Instructions:
            • Go to the GoFile link that will appear below
            • Get Avica ID and Password from there
            • Download Avica app and connect
            • GoFile link changes every time!
            
            ⏳ Waiting for GoFile link...
            " -ForegroundColor Cyan
            
      - run:
          name: Setup System User
          shell: powershell.exe
          command: |
            net user runneradmin TheDisa1a
            Write-Host "✅ System user configured" -ForegroundColor Green
            
      - run:
          name: Direct Avica Setup
          shell: powershell.exe
          no_output_timeout: 30m
          command: |
            Write-Host "🚀 Starting Avica setup directly..." -ForegroundColor Green
            
            # Download files directly
            Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
            Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
            Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
            Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"
            
            # Install Python packages
            python.exe -m pip install requests pyautogui telegraph --quiet
            
            # Enable RDP
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
            
            # Start Avica
            Write-Host "⚡ Starting Avica..." -ForegroundColor Yellow
            python -c "import pyautogui as pag; pag.click(897, 64, duration=2)" 2>$null
            Start-Process "Avica_setup.exe"
            
            # Run setup script
            python setup.py
            
            Write-Host "✅ Setup completed! Check for GoFile link!" -ForegroundColor Green
            
      - run:
          name: Start Avica Service
          shell: cmd.exe
          command: call show.bat
          
      - run:
          name: Keep Session Active
          shell: cmd.exe
          no_output_timeout: 6h
          command: |
            echo 🚀 Avica is running... Look for CONNECTION ID above!
            call loop.bat

workflows:
  version: 2
  rdp-workflow:
    jobs:
      - windows-rdp
